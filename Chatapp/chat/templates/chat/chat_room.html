{% extends 'chat/base.html' %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block header %}{% endblock %}

{% block extra_css %}
<style>
    /* Hide the base template wrapper for chat page */
    body {
        padding: 0 !important;
    }

    .container {
        max-width: 100% !important;
        margin: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
        border-radius: 0 !important;
    }

    .header {
        display: none !important;
    }

    .content {
        padding: 0 !important;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .chat-wrapper {
        max-width: 100%;
        width: 100%;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        background: #075e54;
        color: white;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        text-decoration: none;
    }

    .back-btn:hover {
        opacity: 0.8;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #25d366;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: #e5ddd5;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23f0f0f0" opacity="0.05" width="100" height="100"/></svg>');
    }

    .messages-container::-webkit-scrollbar {
        width: 6px;
    }

    .messages-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 3px;
    }

    .message {
        margin-bottom: 8px;
        display: flex;
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    .message.sent {
        justify-content: flex-end;
    }

    .message.received {
        justify-content: flex-start;
    }

    .message-bubble {
        max-width: 65%;
        padding: 6px 10px 8px 10px;
        border-radius: 7.5px;
        word-wrap: break-word;
        position: relative;
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }

    .message.sent .message-bubble {
        background: #dcf8c6;
        color: #000;
    }

    .message.received .message-bubble {
        background: #ffffff;
        color: #000;
    }

    .message-content {
        font-size: 14.2px;
        line-height: 19px;
        margin-bottom: 2px;
        word-break: break-word;
    }

    .message-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: 5px;
        margin: -4px -6px 4px -6px;
        cursor: pointer;
        display: block;
    }

    .message-file {
        display: flex;
        align-items: center;
        padding: 8px;
        background: rgba(0,0,0,0.05);
        border-radius: 5px;
        margin-bottom: 4px;
        text-decoration: none;
        color: inherit;
        font-size: 13px;
    }

    .file-icon {
        font-size: 20px;
        margin-right: 8px;
    }

    .message-time {
        font-size: 11px;
        color: rgba(0,0,0,0.45);
        display: inline-flex;
        align-items: center;
        gap: 3px;
        float: right;
        margin-top: -14px;
        margin-left: 8px;
    }

    .status-tick {
        display: inline-flex;
        align-items: center;
        margin-left: 2px;
    }

    .tick {
        color: rgba(0,0,0,0.45);
        font-size: 15px;
        line-height: 15px;
    }

    .tick.read {
        color: #53bdeb;
    }

    .file-preview {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
        padding: 8px;
        background: white;
        border-radius: 8px;
    }

    .preview-item {
        position: relative;
        padding: 6px 10px;
        background: #e8f5e9;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
    }

    .preview-item img {
        max-width: 60px;
        max-height: 60px;
        border-radius: 4px;
    }

    .remove-preview {
        cursor: pointer;
        color: #d32f2f;
        font-weight: bold;
        margin-left: 4px;
        font-size: 16px;
    }

    .file-input-label {
        cursor: pointer;
        padding: 8px;
        background: transparent;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        font-size: 22px;
        color: #54656f;
    }

    .file-input-label:hover {
        background: rgba(0,0,0,0.05);
    }

    .file-input-label input {
        display: none;
    }

    .notification-badge {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #25d366;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s;
        z-index: 1000;
        cursor: pointer;
        max-width: 280px;
        font-size: 14px;
    }

    @keyframes slideIn {
        from { transform: translateX(350px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .time-divider {
        text-align: center;
        margin: 12px 0;
    }

    .time-divider span {
        background: rgba(255,255,255,0.9);
        padding: 5px 12px;
        border-radius: 7.5px;
        font-size: 12px;
        color: #54656f;
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }

    .message-form {
        background: #f0f0f0;
        padding: 10px 16px;
        border-top: 1px solid #ddd;
    }

    .input-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .message-input {
        flex: 1;
        padding: 10px 12px;
        border: none;
        border-radius: 21px;
        font-size: 15px;
        background: white;
    }

    .message-input:focus {
        outline: none;
    }

    .send-btn {
        background: #075e54;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 21px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
        min-width: 70px;
    }

    .send-btn:hover {
        background: #064d44;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        margin-bottom: 12px;
        color: #075e54;
        text-decoration: none;
        font-weight: 500;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s;
    }

    .back-link:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        transform: translateX(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div id="notification-container"></div>

<div class="chat-wrapper">
    <div class="chat-header">
        <a href="{% url 'user_list' %}" class="back-btn">‚Üê</a>
        <div class="user-avatar">{{ other_user.username.0|upper }}</div>
        <div>
            <div style="font-weight: 500; font-size: 16px;">{{ other_user.username }}</div>
            <div style="font-size: 12px; opacity: 0.8;">Online</div>
        </div>
    </div>

    <div class="chat-container">
        <div class="messages-container" id="messages-container">
        {% for message in messages %}
            <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}">
                <div class="message-bubble">
                    {% if message.image %}
                        <img src="{{ message.image.url }}" alt="Image" class="message-image" onclick="window.open('{{ message.image.url }}', '_blank')">
                    {% endif %}
                    
                    {% if message.file %}
                        <a href="{{ message.file.url }}" download class="message-file">
                            <span class="file-icon">üìé</span>
                            <span>{{ message.file_name|default:"File" }}</span>
                        </a>
                    {% endif %}
                    
                    {% if message.content %}
                        <div class="message-content">
                            {{ message.content }}
                            <span style="display: inline-block; width: 60px;"></span>
                        </div>
                    {% endif %}
                    
                    <div class="message-time">
                        <span>{{ message.timestamp|date:"h:i A" }}</span>
                        {% if message.sender == user %}
                            <span class="status-tick" data-status="{{ message.status }}">
                                {% if message.status == 'sent' %}
                                    <span class="tick">‚úì</span>
                                {% elif message.status == 'delivered' %}
                                    <span class="tick">‚úì‚úì</span>
                                {% elif message.status == 'read' %}
                                    <span class="tick read">‚úì‚úì</span>
                                {% endif %}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>

        <form method="post" enctype="multipart/form-data" class="message-form" id="message-form">
            {% csrf_token %}
            
            <div class="file-preview" id="file-preview" style="display: none;"></div>
            
            <div class="input-row">
                <label class="file-input-label" title="Attach Image">
                    üì∑
                    <input type="file" name="image" id="image-input" accept="image/*">
                </label>
                
                <label class="file-input-label" title="Attach File">
                    üìé
                    <input type="file" name="file" id="file-input">
                </label>
                
                <input type="text" 
                       name="content" 
                       class="message-input" 
                       placeholder="Type a message" 
                       autocomplete="off"
                       id="message-input">
                <button type="submit" class="send-btn">Send</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Scroll to bottom of messages
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }

    scrollToBottom();

    let lastMessageId = {{ messages.last.id|default:0 }};
    
    // File preview handling
    const imageInput = document.getElementById('image-input');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');

    imageInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            fileInput.value = '';
            const file = e.target.files[0];
            showPreview(file, 'image');
        }
    });

    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            imageInput.value = '';
            const file = e.target.files[0];
            showPreview(file, 'file');
        }
    });

    function showPreview(file, type) {
        filePreview.innerHTML = '';
        filePreview.style.display = 'flex';
        const previewDiv = document.createElement('div');
        previewDiv.className = 'preview-item';
        
        if (type === 'image') {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            previewDiv.appendChild(img);
        } else {
            previewDiv.innerHTML = `<span class="file-icon">üìé</span><span>${file.name}</span>`;
        }
        
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-preview';
        removeBtn.textContent = '√ó';
        removeBtn.onclick = function() {
            if (type === 'image') {
                imageInput.value = '';
            } else {
                fileInput.value = '';
            }
            filePreview.innerHTML = '';
            filePreview.style.display = 'none';
        };
        
        previewDiv.appendChild(removeBtn);
        filePreview.appendChild(previewDiv);
    }
    
    // Fetch new messages
    function fetchNewMessages() {
        fetch("{% url 'get_messages' other_user.id %}")
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('messages-container');
                
                if (data.messages.length > 0) {
                    const latestId = data.messages[data.messages.length - 1].id;
                    
                    if (latestId > lastMessageId) {
                        container.innerHTML = '';
                        
                        data.messages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${msg.is_sender ? 'sent' : 'received'}`;
                            messageDiv.setAttribute('data-message-id', msg.id);
                            
                            const date = new Date(msg.timestamp);
                            const timeStr = date.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            
                            let contentHTML = '';
                            if (msg.image) {
                                contentHTML += `<img src="${msg.image}" alt="Image" class="message-image" onclick="window.open('${msg.image}', '_blank')">`;
                            }
                            if (msg.file) {
                                contentHTML += `<a href="${msg.file}" download class="message-file"><span class="file-icon">üìé</span><span>${msg.file_name || 'File'}</span></a>`;
                            }
                            if (msg.content) {
                                contentHTML += `<div class="message-content">${escapeHtml(msg.content)}<span style="display: inline-block; width: 60px;"></span></div>`;
                            }
                            
                            let statusHTML = '';
                            if (msg.is_sender) {
                                let tickClass = msg.status === 'read' ? 'tick read' : 'tick';
                                let tickText = msg.status === 'sent' ? '‚úì' : '‚úì‚úì';
                                statusHTML = `<span class="status-tick" data-status="${msg.status}"><span class="${tickClass}">${tickText}</span></span>`;
                            }
                            
                            messageDiv.innerHTML = `
                                <div class="message-bubble">
                                    ${contentHTML}
                                    <div class="message-time"><span>${timeStr}</span>${statusHTML}</div>
                                </div>
                            `;
                            
                            container.appendChild(messageDiv);
                        });
                        
                        lastMessageId = latestId;
                        scrollToBottom();
                    } else {
                        // Update status ticks only
                        data.messages.forEach(msg => {
                            const messageEl = document.querySelector(`[data-message-id="${msg.id}"]`);
                            if (messageEl && msg.is_sender) {
                                const statusTick = messageEl.querySelector('.status-tick');
                                if (statusTick && statusTick.dataset.status !== msg.status) {
                                    statusTick.dataset.status = msg.status;
                                    let tickClass = msg.status === 'read' ? 'tick read' : 'tick';
                                    let tickText = msg.status === 'sent' ? '‚úì' : '‚úì‚úì';
                                    statusTick.innerHTML = `<span class="${tickClass}">${tickText}</span>`;
                                }
                            }
                        });
                    }
                }
            })
            .catch(error => console.error('Error fetching messages:', error));
    }

    // Check for notifications
    function checkNotifications() {
        fetch("{% url 'check_new_messages' %}")
            .then(response => response.json())
            .then(data => {
                if (data.count > 0 && data.notifications.length > 0) {
                    data.notifications.forEach(notif => {
                        if (notif.sender_id !== {{ other_user.id }}) {
                            showNotification(notif);
                        }
                    });
                }
            })
            .catch(error => console.error('Error checking notifications:', error));
    }

    function showNotification(notif) {
        // Browser notification
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(`New message from ${notif.sender}`, {
                body: notif.content,
                icon: '/static/chat-icon.png'
            });
            
            notification.onclick = function() {
                window.focus();
                window.location.href = `/chat/${notif.sender_id}/`;
                notification.close();
            };
        }
        
        // In-page notification
        const notifContainer = document.getElementById('notification-container');
        const notifDiv = document.createElement('div');
        notifDiv.className = 'notification-badge';
        notifDiv.innerHTML = `<strong>${notif.sender}</strong>: ${notif.content}`;
        notifDiv.onclick = function() {
            window.location.href = `/chat/${notif.sender_id}/`;
        };
        notifContainer.appendChild(notifDiv);
        
        setTimeout(() => notifDiv.remove(), 5000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Poll for messages and notifications
    setInterval(fetchNewMessages, 2000);
    setInterval(checkNotifications, 5000);

    // Form submission
    document.getElementById('message-form').addEventListener('submit', function(e) {
        const input = document.getElementById('message-input');
        const hasImage = imageInput.files.length > 0;
        const hasFile = fileInput.files.length > 0;
        
        if (input.value.trim() === '' && !hasImage && !hasFile) {
            e.preventDefault();
            return false;
        }
    });

    document.getElementById('message-input').focus();
</script>
{% endblock %}
